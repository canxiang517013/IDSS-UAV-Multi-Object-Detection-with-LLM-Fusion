# AirSim无人机键盘控制使用指南

## 概述

本文档说明如何使用键盘控制AirSim仿真环境中的无人机飞行。

## 键盘映射

### 方向控制

| 按键 | 功能 | 说明 |
|-------|------|------|
| **W** | 前进 | 向前飞行 |
| **S** | 后退 | 向后飞行 |
| **A** | 向左 | 向左平移 |
| **D** | 向右 | 向右平移 |
| **Q** | 左转 | 逆时针旋转偏航角 |
| **E** | 右转 | 顺时针旋转偏航角 |

### 高度控制

| 按键 | 功能 | 说明 |
|-------|------|------|
| **PageUp** | 上升 | 增加飞行高度 |
| **PageDown** | 下降 | 降低飞行高度 |

### 功能键

| 按键 | 功能 | 说明 |
|-------|------|------|
| **空格** | 悬停 | 立即停止所有运动，悬停在当前位置 |
| **+** | 加速 | 增加飞行速度（+1 m/s） |
| **-** | 减速 | 降低飞行速度（-1 m/s） |
| **R** | 重置 | 重置无人机到初始位置 |

## 快速开始

### 1. 启动AirSim

确保AirSim仿真环境正在运行：
- Windows：运行`run.bat`
- 按F11进入飞行模式
- 选择合适的场景（如City环境）

### 2. 启动跟踪系统

```bash
python main.py
```

### 3. 连接AirSim

1. 点击"🚁 连接AirSim"按钮
2. 确认连接对话框
3. 等待连接成功提示

### 4. 启用键盘控制

1. 点击"启用键盘控制"按钮
2. 按钮变为红色"禁用键盘控制"
3. 使用键盘控制无人机飞行

## 操作示例

### 基础飞行

**向前飞行**：按住W键
```
按住W → 无人机向前飞行 → 松开W → 停止
```

**向后飞行**：按住S键
```
按住S → 无人机向后飞行 → 松开S → 停止
```

### 转向飞行

**前进+左转**：同时按住W+Q
```
按住W+Q → 无人机边前进边左转 → 松开按键 → 停止
```

**前进+右转**：同时按住W+E
```
按住W+E → 无人机边前进边右转 → 松开按键 → 停止
```

### 高度调整

**上升**：按住PageUp
```
按住PageUp → 无人机上升 → 松开PageUp → 停止上升
```

**下降**：按住PageDown
```
按住PageDown → 无人机下降 → 松开PageDown → 停止下降
```

### 速度调整

**加速**：按+键
```
按一次+ → 速度+1 m/s → 显示更新
```

**减速**：按-键
```
按一次- → 速度-1 m/s → 显示更新
```

### 紧急停止

**悬停**：按空格键
```
按空格 → 立即悬停 → 所有运动停止
```

## 高级操作

### 组合动作

系统支持多键同时按下，实现复杂的飞行动作：

**斜向飞行**：W+A或W+D
```
按住W+A → 左前方飞行
按住W+D → 右前方飞行
```

**螺旋上升**：W+Q+PageUp
```
按住W+Q+PageUp → 边前进边左转边上升
```

**精准控制**：短按+调整速度
```
短按W → 移动一小段距离
按几次- → 降低速度 → 再长按W → 精准控制
```

### 战术机动

**盘旋**：Q或E长按
```
按住Q → 持续左转 → 360度盘旋
按住E → 持续右转 → 360度盘旋
```

**升降机动**：快速切换PageUp/PageDown
```
快速按PageUp几次 → 快速爬升
快速按PageDown几次 → 快速俯冲
```

## 配置参数

在`config/config.yaml`中可以调整键盘控制参数：

```yaml
keyboard:
  enabled: false              # 是否默认启用
  default_speed: 5.0          # 默认速度 m/s
  rotation_speed: 30.0        # 旋转速度 度/秒
  vertical_speed: 2.0         # 垂直速度 m/s
  max_speed: 20.0             # 最大速度 m/s
  min_speed: 1.0              # 最小速度 m/s
  update_frequency: 50          # 更新频率（毫秒）
```

### 参数说明

- **default_speed**：初始飞行速度，建议5-10 m/s
- **rotation_speed**：旋转速度，建议20-45 度/秒
- **vertical_speed**：垂直移动速度，建议1-3 m/s
- **max_speed**：最大速度限制，防止过快失控
- **min_speed**：最小速度限制，便于精准控制
- **update_frequency**：控制更新频率，50ms = 20Hz

### 调整建议

**新手模式**：
```yaml
default_speed: 3.0
rotation_speed: 20.0
vertical_speed: 1.0
```

**标准模式**：
```yaml
default_speed: 5.0
rotation_speed: 30.0
vertical_speed: 2.0
```

**高速模式**：
```yaml
default_speed: 10.0
rotation_speed: 45.0
vertical_speed: 3.0
```

## 技术细节

### 控制原理

系统使用**速度控制**而非位置控制：
- 按键时：发送速度指令到AirSim
- 松键时：速度归零，无人机停止
- 持续按键：定时器以20Hz频率重复发送指令

### 更新频率

键盘控制以20Hz频率更新（每50ms一次）：
- 确保流畅的连续飞行
- 支持多键同时按下
- 快速响应按键事件

### 焦点管理

窗口需要获取键盘焦点：
- 启用键盘控制时自动设置焦点
- 如果控制失效，点击视频区域重新聚焦
- 确保没有其他窗口抢占焦点

## 常见问题

### Q1: 键盘控制无响应

**可能原因**：
- 窗口未获得焦点
- 键盘控制未启用
- AirSim未连接

**解决方案**：
1. 点击视频区域获取焦点
2. 确认"启用键盘控制"按钮已按下
3. 检查状态栏显示"AirSim已连接"

### Q2: 无人机移动不平滑

**可能原因**：
- 更新频率过低
- 网络延迟
- AirSim性能问题

**解决方案**：
1. 检查`update_frequency`配置（建议50ms）
2. 检查网络连接
3. 降低AirSim图像分辨率

### Q3: 速度无法调整

**可能原因**：
- 已达到最大/最小速度限制
- 键盘控制未启用

**解决方案**：
1. 检查当前速度显示
2. 确认速度在1-20 m/s范围内
3. 重新启用键盘控制

### Q4: 按键冲突

**可能原因**：
- 输入法切换
- 快捷键冲突
- 系统热键干扰

**解决方案**：
1. 切换到英文输入法
2. 检查其他应用快捷键
3. 关闭可能冲突的应用

## 安全提示

### 1. 速度控制

- **新手**：从低速开始（3-5 m/s）
- **熟悉后**：逐渐提高速度
- **高风险区域**：降低速度

### 2. 高度管理

- **最低高度**：不低于10米
- **最高高度**：不高于150米
- **过渡高度**：使用PageUp/PageDown逐步调整

### 3. 紧急处理

- **遇到障碍**：立即按空格悬停
- **失控**：按R重置位置
- **碰撞风险**：快速下降并悬停

### 4. 环境意识

- **观察周边**：定期旋转查看环境
- **注意目标**：配合目标检测信息
- **避免盲区**：不要长时间单一方向飞行

## 训练建议

### 阶段一：基础操作（10分钟）

1. **直线飞行**：W/S键前进后退
2. **侧向飞行**：A/D键左右移动
3. **高度调整**：PageUp/PageDown升降
4. **原地旋转**：Q/E键旋转

**目标**：熟悉每个按键的效果

### 阶段二：组合操作（15分钟）

1. **转向飞行**：W+Q或W+E
2. **斜向飞行**：W+A或W+D
3. **螺旋上升**：W+Q+PageUp
4. **速度调整**：飞行中按+/-调整速度

**目标**：掌握多键组合

### 阶段三：任务演练（20分钟）

1. **目标跟踪**：飞向检测到的目标
2. **环绕观察**：围绕目标盘旋
3. **高度侦察**：从不同高度观察
4. **紧急规避**：快速机动避免碰撞

**目标**：实际应用场景演练

### 阶段四：高级技巧（持续）

1. **精准降落**：低速精准控制高度
2. **高速穿越**：在开放区域高速飞行
3. **复杂地形**：在城市环境中导航
4. **多目标**：在多个目标间切换

**目标**：提高操作熟练度

## 性能优化

### 降低延迟

1. **提高更新频率**：
```yaml
update_frequency: 30  # 33Hz
```

2. **减少网络延迟**：
   - 使用本地AirSim（127.0.0.1）
   - 避免远程连接
   - 使用有线网络

3. **降低图像分辨率**：
   - AirSim设置中降低摄像头分辨率
   - 减少图像处理负担

### 提升流畅度

1. **增加更新频率**（需测试）：
```yaml
update_frequency: 40  # 25Hz
```

2. **调整速度参数**：
```yaml
rotation_speed: 45.0  # 更快的旋转
vertical_speed: 3.0   # 更快的升降
```

3. **关闭不必要的功能**：
   - 暂时关闭LLM分析
   - 降低检测频率

## 与目标检测配合

### 1. 跟踪模式

- **飞向目标**：观察检测到的目标ID
- **保持距离**：根据估算距离调整飞行
- **环绕观察**：使用Q/E旋转查看目标细节

### 2. 搜索模式

- **网格飞行**：系统化搜索区域
- **高度变化**：使用PageUp/PageDown改变视角
- **速度控制**：低速仔细搜索

### 3. 监控模式

- **悬停观察**：按空格悬停，让系统分析
- **高度调整**：从不同高度监控
- **区域切换**：使用WASD快速切换监控区域

## 故障排除

### 日志查看

键盘控制的日志会输出到`logs/`目录：
- `UIApp.log`：UI事件日志
- `KeyboardController.log`：键盘控制日志

### 常见错误

**`KeyError: 按键未映射`**：
- 检查按键是否在映射表中
- 确认使用正确的按键

**`RuntimeError: 未连接到AirSim服务器`**：
- 先连接AirSim
- 检查AirSim是否正在运行

**`AttributeError: 'NoneType' object has no attribute`**：
- 重新启用键盘控制
- 重启应用程序

## 总结

键盘控制提供了直观、灵活的无人机飞行方式：

✅ **简单易学** - WASD方向控制，直观易懂
✅ **实时响应** - 20Hz更新频率，流畅控制
✅ **多键支持** - 同时按下多个按键，组合动作
✅ **可配置** - 速度、频率等参数可调整
✅ **安全可靠** - 紧急悬停、速度限制

通过练习和熟悉，您将能够熟练地控制AirSim无人机，配合目标检测和智能分析功能，完成各种复杂的飞行任务！
